<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gest√£o Contratual ‚Äî Prot√≥tipo Completo</title>
  <style>
    :root{
      --blue:#0a6cff;
      --dark:#0b1220;
      --muted:#7b7b7b;
      --card-bg:#f7f9fc;
      --accent:#0a6cff;
      --radius:10px;
      --max-width:1200px;
      --gap:18px;
      --bg: #ffffff;
      --text: #0b1220;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    [data-theme="dark"]{
      --bg: #071023;
      --text: #e6eef9;
      --card-bg: #0b1227;
    }

    *{box-sizing:border-box}
    html,body,#app{height:100%;}
    body{
      margin:0;
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
    }

    /* layout */
    .app{display:flex;min-height:100vh;gap:var(--gap);max-width:1400px;margin:20px auto;padding:20px}
    .sidebar{width:240px;background:var(--accent);color:white;padding:18px;border-radius:12px;display:flex;flex-direction:column;gap:12px;flex-shrink:0}
    .logo{font-weight:800;font-size:22px;color:#fff;display:flex;align-items:center;gap:8px}
    .nav-btn{background:transparent;border:none;color:#fff;padding:10px 12px;border-radius:8px;text-align:left;cursor:pointer;font-weight:600}
    .nav-btn:hover{background:rgba(255,255,255,0.08)}
    .sidebar .muted{opacity:0.85;font-size:13px}

    .main{flex:1;min-width:0}
    .top{display:flex;align-items:center;justify-content:space-between;padding:6px 12px}
    .greeting{font-size:18px;font-weight:600}

    .search-wrap{display:flex;align-items:center;gap:12px;max-width:480px}
    .search{flex:1;border:2px solid rgba(11,18,32,0.06);padding:10px 14px;border-radius:999px;outline:none;background:transparent;color:var(--text)}

    .controls{display:flex;gap:18px;padding:20px 0;flex-wrap:wrap}
    .filter{background:var(--card-bg);padding:12px 20px;border-radius:12px;min-width:160px;text-align:center;font-weight:600}
    .new-ct{background:var(--accent);color:white;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}

    /* cards and table */
    .card{background:transparent;padding:18px;border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:15px}
    th,td{padding:10px 12px}
    thead th{font-weight:700;border-bottom:2px solid rgba(11,18,32,0.06);text-align:left}
    tbody tr td{border-bottom:1px solid rgba(11,18,32,0.04)}
    .status{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}

    .status.ativo{background:#e8f5ff;color:#0a6cff}
    .status.vence{background:#fff6e6;color:#d47b00}
    .status.encerrado{background:#fdecec;color:#bd0505}
    .status.analise{background:#eef7f0;color:#2a8a4a}

    .actions button{margin-left:6px;border-radius:8px;border:1px solid rgba(11,18,32,0.06);padding:6px 8px;cursor:pointer;background:transparent}
    .action-small{font-size:14px;padding:6px 8px;border-radius:6px}

    /* forms */
    .form-wrap{max-width:980px;margin:0 auto;background:transparent;padding:20px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .form-grid input, .form-grid textarea, .form-grid select{padding:10px;border:1px solid rgba(11,18,32,0.07);border-radius:8px;background:transparent;color:var(--text);outline:none}
    .form-full{grid-column:1/-1}
    .submit{margin-top:14px;background:#243b7a;color:white;border-radius:8px;padding:10px 16px;border:none;cursor:pointer}

    /* login */
    .login{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;height:70vh}
    .login-card{max-width:420px;width:100%;padding:26px;border-radius:12px;background:var(--card-bg);box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .login-card h2{color:var(--accent);text-align:center;margin-bottom:18px}
    .field{margin-bottom:12px}
    .field input{width:100%;padding:10px;border:1px solid rgba(11,18,32,0.06);border-radius:8px;outline:none;background:transparent;color:var(--text)}
    .login-btn{width:100%;padding:10px;background:var(--accent);color:white;border-radius:8px;border:none;cursor:pointer}

    /* small helpers */
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;align-items:center}
    .right{text-align:right}

    /* attachments list */
    .attachments-list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
    .attach-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;border:1px solid rgba(11,18,32,0.04)}

    /* responsive */
    @media (max-width:768px){
      .app{flex-direction:column;padding:12px}
      .sidebar{width:100%;flex-direction:row;flex-wrap:wrap;justify-content:space-between;gap:8px}
      .form-grid{grid-template-columns:1fr}
      .search-wrap{max-width:100%}
    }

      @media (max-width:375px){
      .app{flex-direction:column;padding:12px}
      .sidebar{width:100%;flex-direction:row;flex-wrap:wrap;justify-content:space-between;gap:8px}
      .form-grid{grid-template-columns:1fr}
      .search-wrap{max-width:100%}
    }

    @media (max-width:1280px){
      .app{flex-direction:column;padding:12px}
      .sidebar{width:100%;flex-direction:row;flex-wrap:wrap;justify-content:space-between;gap:8px}
      .form-grid{grid-template-columns:1fr}
      .search-wrap{max-width:100%}
    }

    /* ===== PAINEL DE GEST√ÉO ===== */

.dashboard {
    padding: 20px;
}

.dashboard h2 {
    margin-bottom: 20px;
    font-size: 26px;
}

/* ==== CARDS ==== */

.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
}

.dash-card {
    background: white;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.dash-card h3 {
    margin-bottom: 10px;
    font-size: 16px;
}

.dash-number {
    font-size: 32px;
    font-weight: bold;
}

.dash-number.alert {
    color: #d9534f;
}

.dash-number.success {
    color: #5cb85c;
}

.dash-sub {
    font-size: 12px;
    color: #777;
}

/* ==== GR√ÅFICO CIRCULAR ==== */

.dashboard-graphic-container {
    display: flex;
    gap: 30px;
    margin-top: 30px;
    align-items: center;
}

.circle-chart {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: conic-gradient(#28a745 0% 72%, #ddd 72% 100%);
    position: relative;
}

.inner-circle {
    width: 120px;
    height: 120px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 30px;
    left: 30px;
}

.circle-label {
    position: absolute;
    width: 100%;
    top: 55px;
    text-align: center;
    font-size: 28px;
    font-weight: bold;
}

.circle-label span {
    font-size: 12px;
    color: #777;
}

/* ==== BARRAS DE PROGRESSO ==== */

.section-title {
    margin-top: 40px;
    margin-bottom: 10px;
    font-size: 20px;
}

.progress-block {
    margin-bottom: 12px;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: #e5e5e5;
    border-radius: 8px;
}

.progress-bar div {
    height: 10px;
    background: #007bff;
    border-radius: 8px;
}

/* ==== TABELA ==== */

.dashboard-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: 14px;
    overflow: hidden;
}

.dashboard-table th, .dashboard-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
    text-align: left;
}

.status {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    color: white;
}

.status.green { background: #28a745; }
.status.yellow { background: #ffc107; }
.status.red { background: #dc3545; }

/* ==== RESPONSIVIDADE ==== */

 @media (max-width:768px){
      .app{flex-direction:column;padding:12px}
      .sidebar{width:100%;flex-direction:row;flex-wrap:wrap;justify-content:space-between;gap:8px}
      .form-grid{grid-template-columns:1fr}
      .search-wrap{max-width:100%}
    }

      @media (max-width:375px){
      .app{flex-direction:column;padding:12px}
      .sidebar{width:100%;flex-direction:row;flex-wrap:wrap;justify-content:space-between;gap:8px}
      .form-grid{grid-template-columns:1fr}
      .search-wrap{max-width:100%}
    }

    @media (max-width:1280px){
      .app{flex-direction:column;padding:12px}
      .sidebar{width:100%;flex-direction:row;flex-wrap:wrap;justify-content:space-between;gap:8px}
      .form-grid{grid-template-columns:1fr}
      .search-wrap{max-width:100%}
    }
.sidebar .logo {
  width: 120px;     /* largura do espa√ßo do logo */
  padding: 20px 0;  /* espa√ßo acima/abaixo */
  display: flex;
  justify-content: center;  /* centraliza horizontalmente */
  background: transparent !important;
  width: auto;
  height: auto;
  padding: 0;
  background: none;
   box-shadow: 0 2px 6px rgba(0,0,0,0.15); 
}

.sidebar .logo img {
  width: 100%;      /* imagem ajusta ao tamanho do container */
  height: auto;     /* mant√©m propor√ß√£o */
}

  </style>
</head>
<body data-theme="light">
  <div id="app" class="app">

    <aside class="sidebar">
      <div class="logo">
         <img src="file:///C:/Users/renato.rocha/Downloads/988e46a2-72a2-458d-9b88-9863f1d56e74.png" alt="Logo da Empresa">
      </div>
      <div class="muted">Prototipo ‚Ä¢ 2025</div>
      <button class="nav-btn" data-page="dashboard">Meus Contratos</button>
      <button class="nav-btn" data-page="renew">Contratos a Renovar</button>
      <button class="nav-btn" data-page="attachments">Anexos & Documentos</button>
      <button class="nav-btn" data-page="config">Configura√ß√µes</button>
      <div style="margin-top:auto;font-size:12px;opacity:0.9" id="companyLabel">Empresa: ‚Äî</div>
    </aside>

    <main class="main">
      <!-- Login view -->
      <section id="page-login" class="login" style="display:none">
        <div class="login-card">
          <h2>Login (simulado)</h2>
          <div class="field"><input id="loginUser" placeholder="Nome do usu√°rio (ex: Mariana Oliveira)" type="text"></div>
          <div class="field"><input id="loginEmail" placeholder="E-mail" type="email"></div>
          <button class="login-btn" id="btnLogin">Entrar</button>
        </div>
      </section>

      <!-- Dashboard view -->
      <section id="page-dashboard">
        <div class="top">
          <div class="greeting">Ol√°, <span id="userName">Seja Bem-Vindo!</span>!</div>
          <div class="search-wrap">
            <input class="search" placeholder="Pesquisar contratos, fornecedor, respons√°vel..." id="search"/>
            <div class="muted" style="font-size:13px;margin-left:6px">Total: <strong id="totalCount">0</strong></div>
          </div>
        </div>

        <div class="controls">
          <div class="filter">Status: <span id="filterStatus" style="font-weight:600;margin-left:8px">Todos</span></div>
          <div class="filter">Pr√≥ximos 60 dias: <strong id="expiring-count">0</strong></div>
          <div style="flex:1"></div>
          <button class="new-ct" id="openNew">Novo contrato</button>
        </div>

        <div class="card">
          <table>
            <thead>
              <tr>
                <th>N¬∫ Contrato</th>
                <th>Fornecedor</th>
                <th>Respons√°vel</th>
                <th>In√≠cio</th>
                <th>Fim</th>
                <th>Valor (R$)</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tb">
              <!-- rows inserted by JS -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Novo / Editar Contrato view -->
      <section id="page-novo" style="display:none">
        <div class="form-wrap">
          <h2 style="text-align:center;color:var(--accent)" id="formTitle">Novo contrato</h2>
          <form id="novoForm">
            <div class="form-grid">
              <input name="titulo" placeholder="T√≠tulo" class="form-full" />
              <input name="empresa" placeholder="Empresa" />
              <input name="numero" placeholder="N√∫mero (ex: CT-001/2025)" />
              <input name="modalidade" placeholder="Modalidade" />
              <textarea name="contratado" placeholder="Partes (Qualifica√ß√£o) - Contratado" class="form-full"></textarea>
              <textarea name="contratante" placeholder="Partes (Qualifica√ß√£o) - Contratante" class="form-full"></textarea>
              <input name="inicio" placeholder="Data de in√≠cio" type="date" />
              <input name="fim" placeholder="Data de t√©rmino" type="date" />
              <input name="vigencia" placeholder="Vig√™ncia e Prazo" class="form-full" />
              <input name="rescisao" placeholder="Rescis√£o e Multa" class="form-full" />
              <input name="valor" placeholder="Valor (R$)" />
              <select name="status">
                <option value="Ativo">Ativo</option>
                <option value="Em Renova√ß√£o">Em Renova√ß√£o</option>
                <option value="Vencido">Vencido</option>
                <option value="Em An√°lise">Em An√°lise</option>
                <option value="Encerrado">Encerrado</option>
              </select>
              <input name="responsavel" placeholder="Respons√°vel (nome)" />
            </div>
            <div style="text-align:right;margin-top:12px">
              <button class="submit" type="submit">Salvar</button>
              <button class="submit" type="button" id="cancelForm" style="background:#999;margin-left:8px">Cancelar</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Contratos a renovar -->
      <section id="page-renew" style="display:none">
        <div class="card container">
          <h2>Contratos a Renovar (pr√≥ximos 60 dias)</h2>
          <p class="muted">Lista autom√°tica baseada na data de t√©rmino.</p>
          <table>
            <thead>
              <tr><th>N¬∫</th><th>Fornecedor</th><th>Fim</th><th>Dias Restantes</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="tbRenew"></tbody>
          </table>
        </div>
      </section>

      <!-- Anexos & Documentos -->
      <section id="page-attachments" style="display:none">
        <div class="card container">
          <h2>Anexos & Documentos</h2>
          <p class="muted">Upload simulado ‚Äî os arquivos ficam no localStorage (somente front-end).</p>
          <div style="display:flex;gap:12px;align-items:center;margin:12px 0">
            <input type="file" id="fileInput" />
            <select id="fileContratoSelect"></select>
            <button class="submit" id="uploadBtn">Upload</button>
          </div>
          <ul class="attachments-list" id="attachmentsList"></ul>
        </div>
      </section>

      <!-- Configura√ß√µes -->
      <section id="page-config" style="display:none">
        <div class="card container">
          <h2>Configura√ß√µes</h2>
          <form id="configForm" style="max-width:600px">
            <div class="form-grid">
              <input name="companyName" placeholder="Nome da empresa" />
              <input name="notificationEmail" placeholder="E-mail para notifica√ß√µes" />
              <select name="theme">
                <option value="light">Tema: Claro</option>
                <option value="dark">Tema: Escuro</option>
              </select>
            </div>
            <div style="text-align:right;margin-top:12px">
              <button class="submit" type="submit">Salvar</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Meus Contratos -->
      <section id="page-meus" style="display:none">
        <div class="card container">
          <h2>Meus Contratos</h2>
          <p class="muted">Contratos onde voc√™ √© o respons√°vel (usu√°rio logado).</p>
          <table>
            <thead><tr><th>N¬∫</th><th>Fornecedor</th><th>In√≠cio</th><th>Fim</th><th>Status</th><th>A√ß√µes</th></tr></thead>
            <tbody id="tbMeus"></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

  <script>
    /*********************
     *  Prot√≥tipo JS
     *  - persiste em localStorage
     *  - telas: dashboard, novo, renew, attachments, config, meus
     *********************/

    // --- Initial fake DB (will be stored to localStorage on first load)
    const SAMPLE_CONTRACTS = [
      { id: 101, numero:'CT-101/2024', titulo:'Fornecimento de TI', empresa:'AlfaTech Solu√ß√µes LTDA', fornecedor:'AlfaTech Solu√ß√µes LTDA', contratante:'Empresa X', contratado:'AlfaTech', responsavel:'Mariana Oliveira', inicio:'2024-01-05', fim:'2025-01-05', valor:'185000.00', vigencia:'12 meses', rescisao:'Multa 10%', status:'Ativo', modalidade:'Servi√ßos' },
      { id: 102, numero:'CT-102/2024', titulo:'Servi√ßos de Limpeza', empresa:'Beta Servi√ßos', fornecedor:'Beta Servi√ßos de Limpeza', contratante:'Empresa Y', contratado:'Beta Servi√ßos', responsavel:'Jo√£o Pereira', inicio:'2024-03-10', fim:'2025-03-10', valor:'72500.00', vigencia:'12 meses', rescisao:'Multa 5%', status:'Em Renova√ß√£o', modalidade:'Terceiriza√ß√£o' },
      { id: 103, numero:'CT-103/2023', titulo:'Consultoria Estrat√©gica', empresa:'Delta Consultoria', fornecedor:'Delta Consultoria', contratante:'Empresa Z', contratado:'Delta', responsavel:'Ana Souza', inicio:'2023-02-15', fim:'2024-02-15', valor:'210000.00', vigencia:'12 meses', rescisao:'Multa 12%', status:'Vencido', modalidade:'Consultoria' },
      { id: 104, numero:'CT-104/2025', titulo:'Servi√ßos de Telecom', empresa:'SkyNet Telecom', fornecedor:'SkyNet Telecom', contratante:'Empresa A', contratado:'SkyNet', responsavel:'Ricardo Lima', inicio:'2025-07-01', fim:'2027-07-01', valor:'348900.00', vigencia:'24 meses', rescisao:'Conforme cl√°usula', status:'Em An√°lise', modalidade:'Infraestrutura' },
      { id: 105, numero:'CT-105/2024', titulo:'Fornecimento Escrit√≥rio', empresa:'GreenOffice', fornecedor:'GreenOffice Supplies', contratante:'Empresa B', contratado:'GreenOffice', responsavel:'Laura Martins', inicio:'2024-09-22', fim:'2026-09-22', valor:'94300.00', vigencia:'24 meses', rescisao:'Multa 8%', status:'Ativo', modalidade:'Fornecimento' },
      // add more to show table density
      { id: 106, numero:'CT-106/2024', titulo:'Manuten√ß√£o Predial', empresa:'ManutPred', fornecedor:'ManutPred Ltda', contratante:'Empresa C', contratado:'ManutPred', responsavel:'Mariana Oliveira', inicio:'2024-05-01', fim:'2025-05-01', valor:'42000.00', vigencia:'12 meses', rescisao:'Multa 6%', status:'Ativo', modalidade:'Servi√ßos' },
      { id: 107, numero:'CT-107/2024', titulo:'Seguran√ßa Patrimonial', empresa:'SegPlus', fornecedor:'SegPlus Seguran√ßa', contratante:'Empresa D', contratado:'SegPlus', responsavel:'Carlos Mendes', inicio:'2024-10-15', fim:'2025-10-15', valor:'98000.00', vigencia:'12 meses', rescisao:'Multa 7%', status:'Ativo', modality:'Servi√ßos' },
      { id: 108, numero:'CT-108/2024', titulo:'Marketing Digital', empresa:'MarketNow', fornecedor:'MarketNow Ag√™ncia', contratante:'Empresa E', contratado:'MarketNow', responsavel:'Ana Souza', inicio:'2024-11-01', fim:'2025-05-01', valor:'35000.00', vigencia:'6 meses', rescisao:'Proporcional', status:'Em Renova√ß√£o', modalidade:'Marketing' }
    ];

    const STORAGE_KEYS = {
      contracts: 'prot_contracts_v1',
      attachments: 'prot_attachments_v1',
      settings: 'prot_settings_v1',
      user: 'prot_user_v1'
    };

    // --- util helpers
    function saveContracts(list){ localStorage.setItem(STORAGE_KEYS.contracts, JSON.stringify(list)); }
    function loadContracts(){
      const raw = localStorage.getItem(STORAGE_KEYS.contracts);
      if(!raw){ localStorage.setItem(STORAGE_KEYS.contracts, JSON.stringify(SAMPLE_CONTRACTS)); return SAMPLE_CONTRACTS.slice(); }
      try { return JSON.parse(raw); } catch(e){ return SAMPLE_CONTRACTS.slice(); }
    }

    function saveAttachments(list){ localStorage.setItem(STORAGE_KEYS.attachments, JSON.stringify(list)); }
    function loadAttachments(){ const raw = localStorage.getItem(STORAGE_KEYS.attachments); return raw ? JSON.parse(raw) : []; }

    function saveSettings(s){ localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(s)); }
    function loadSettings(){ const raw = localStorage.getItem(STORAGE_KEYS.settings); return raw ? JSON.parse(raw) : { companyName:'Mirai Ltda', notificationEmail:'', theme:'light' }; }

    function saveUser(u){ localStorage.setItem(STORAGE_KEYS.user, JSON.stringify(u)); }
    function loadUser(){ const raw = localStorage.getItem(STORAGE_KEYS.user); return raw ? JSON.parse(raw) : null; }

    function formatDateISOtoBR(iso){
      if(!iso) return '‚Äî';
      const d = new Date(iso + (iso.length===10? 'T00:00:00' : ''));
      if(isNaN(d)) return iso;
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return dd + '/' + mm + '/' + yyyy;
    }

    function daysUntil(isoDate){
      const now = new Date(); now.setHours(0,0,0,0);
      const d = new Date(isoDate + 'T00:00:00');
      const diff = Math.ceil((d - now) / (1000*60*60*24));
      return diff;
    }

    // --- state
    let contracts = loadContracts();
    let attachments = loadAttachments();
    let settings = loadSettings();
    let currentUser = loadUser(); // {name,email}

    // --- UI refs
    const tb = document.getElementById('tb');
    const totalCountEl = document.getElementById('totalCount');
    const expiringCountEl = document.getElementById('expiring-count');
    const companyLabel = document.getElementById('companyLabel');
    const userNameEl = document.getElementById('userName');

    // initialize labels
    function applySettings(){
      document.body.setAttribute('data-theme', settings.theme || 'light');
      companyLabel.textContent = 'Empresa: ' + (settings.companyName || '‚Äî');
      document.querySelectorAll('[name="companyName"]').forEach(i => { if(i) i.value = settings.companyName || ''; });
      document.querySelectorAll('[name="notificationEmail"]').forEach(i => { if(i) i.value = settings.notificationEmail || ''; });
      document.querySelectorAll('[name="theme"]').forEach(s => { if(s) s.value = settings.theme || 'light'; });
    }

    function renderTable(list){
      tb.innerHTML = '';
      list.forEach((c, i)=>{
        const tr = document.createElement('tr');
        // status class logic
        const statusClass = (c.status || '').toLowerCase().includes('ativo') ? 'ativo'
          : (c.status || '').toLowerCase().includes('vence') ? 'vence'
          : (c.status || '').toLowerCase().includes('encerr') ? 'encerrado'
          : 'analise';
        const valorDisplay = c.valor ? Number(c.valor).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '0,00';
        tr.innerHTML = `
          <td>${c.numero || '‚Äî'}</td>
          <td>${c.fornecedor || c.empresa || '‚Äî'}</td>
          <td>${c.responsavel || '‚Äî'}</td>
          <td>${formatDateISOtoBR(c.inicio)}</td>
          <td>${formatDateISOtoBR(c.fim)}</td>
          <td>R$ ${valorDisplay}</td>
          <td><span class="status ${statusClass}">${c.status || '‚Äî'}</span></td>
          <td class="actions">
            <button class="action-small" title="Visualizar" onclick="viewContract(${c.id})">üîç</button>
            <button class="action-small" title="Editar" onclick="startEdit(${c.id})">‚úèÔ∏è</button>
            <button class="action-small" title="Excluir" onclick="deleteContract(${c.id})">üóëÔ∏è</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      totalCountEl.textContent = list.length;
      expiringCountEl.textContent = contracts.filter(c => {
        if(!c.fim) return false;
        const d = daysUntil(c.fim);
        return d >= 0 && d <= 60;
      }).length;
    }

    // --- CRUD
    function createContract(obj){
      obj.id = Date.now() + Math.floor(Math.random()*999);
      contracts.push(obj);
      saveContracts(contracts);
      renderTable(contracts);
      fillContractSelect();
    }
    function updateContract(id, obj){
      const idx = contracts.findIndex(c => c.id === id);
      if(idx>-1){ contracts[idx] = {...contracts[idx], ...obj}; saveContracts(contracts); renderTable(contracts); fillContractSelect(); }
    }
    function deleteContract(id){
      if(!confirm('Deseja excluir o contrato selecionado?')) return;
      contracts = contracts.filter(c => c.id !== id);
      saveContracts(contracts);
      renderTable(contracts);
      fillContractSelect();
    }

    // view in alert (simple)
    function viewContract(id){
      const c = contracts.find(x => x.id === id);
      if(!c) return alert('Contrato n√£o encontrado');
      const txt = `
N√∫mero: ${c.numero}
T√≠tulo: ${c.titulo || '‚Äî'}
Fornecedor: ${c.fornecedor}
Respons√°vel: ${c.responsavel}
In√≠cio: ${formatDateISOtoBR(c.inicio)}
Fim: ${formatDateISOtoBR(c.fim)}
Valor: R$ ${Number(c.valor||0).toLocaleString('pt-BR', {minimumFractionDigits:2})}
Status: ${c.status}
Vig√™ncia: ${c.vigencia || '‚Äî'}
Rescis√£o: ${c.rescisao || '‚Äî'}
      `;
      alert(txt);
    }

    // --- Edit flow (populate form)
    let editingId = null;
    function startEdit(id){
      const c = contracts.find(x => x.id===id);
      if(!c) return alert('Contrato n√£o encontrado');
      editingId = id;
      show('novo');
      document.getElementById('formTitle').textContent = 'Editar contrato';
      // populate form
      const f = document.getElementById('novoForm');
      f.elements['titulo'].value = c.titulo || '';
      f.elements['empresa'].value = c.empresa || c.fornecedor || '';
      f.elements['numero'].value = c.numero || '';
      f.elements['modalidade'].value = c.modalidade || '';
      f.elements['contratado'].value = c.contratado || '';
      f.elements['contratante'].value = c.contratante || '';
      f.elements['inicio'].value = c.inicio || '';
      f.elements['fim'].value = c.fim || '';
      f.elements['vigencia'].value = c.vigencia || '';
      f.elements['rescisao'].value = c.rescisao || '';
      f.elements['valor'].value = c.valor || '';
      f.elements['status'].value = c.status || 'Ativo';
      f.elements['responsavel'].value = c.responsavel || '';
    }

    // --- Navigation
    const pages = {
      login:'#page-login', dashboard:'#page-dashboard', novo:'#page-novo',
      renew:'#page-renew', attachments:'#page-attachments', config:'#page-config',
      meus:'#page-meus'
    };

    function show(page){
      Object.values(pages).forEach(sel=>{
        const el = document.querySelector(sel);
        if(el) el.style.display = 'none';
      });
      const target = document.querySelector(pages[page]);
      if(target) target.style.display = 'block';
      // update some dynamic content
      if(page === 'dashboard') renderTable(contracts);
      if(page === 'renew') renderRenewals();
      if(page === 'attachments') renderAttachments();
      if(page === 'meus') renderMyContracts();
    }

    // sidebar nav wiring
    document.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const page = btn.getAttribute('data-page');
        if(page === 'dashboard') show('dashboard');
        else if(page === 'renew') show('renew');
        else if(page === 'attachments') show('attachments');
        else if(page === 'config') show('config');
      });
    });

    // initial show
    function ensureUser(){
      currentUser = loadUser();
      if(currentUser){
        userNameEl.textContent = currentUser.name;
      } else {
        userNameEl.textContent = 'visitante';
      }
    }

    // wire new contract button
    document.getElementById('openNew').addEventListener('click', ()=>{
      editingId = null;
      document.getElementById('formTitle').textContent = 'Novo contrato';
      document.getElementById('novoForm').reset();
      show('novo');
    });

    document.getElementById('cancelForm').addEventListener('click', ()=>{
      show('dashboard');
      editingId = null;
    });

    // form submit (create or update)
    document.getElementById('novoForm').addEventListener('submit', function(e){
      e.preventDefault();
      const data = new FormData(this);
      const obj = {
        titulo: data.get('titulo'),
        empresa: data.get('empresa'),
        numero: data.get('numero'),
        modalidade: data.get('modalidade'),
        contratado: data.get('contratado'),
        contratante: data.get('contratante'),
        inicio: data.get('inicio'),
        fim: data.get('fim'),
        vigencia: data.get('vigencia'),
        rescisao: data.get('rescisao'),
        valor: data.get('valor'),
        status: data.get('status'),
        responsavel: data.get('responsavel')
      };
      if(editingId){
        updateContract(editingId, obj);
        alert('Contrato atualizado.');
        editingId = null;
      } else {
        createContract(obj);
        alert('Contrato criado.');
      }
      this.reset();
      show('dashboard');
    });

    // search
    document.getElementById('search').addEventListener('input', function(){
      const q = this.value.toLowerCase().trim();
      if(!q) return renderTable(contracts);
      const filtered = contracts.filter(c => (Object.values(c).join(' ')).toLowerCase().includes(q));
      renderTable(filtered);
    });

    // --- Renewals
    function renderRenewals(){
      const tbRenew = document.getElementById('tbRenew');
      tbRenew.innerHTML = '';
      const today = new Date(); today.setHours(0,0,0,0);
      contracts.forEach(c => {
        if(!c.fim) return;
        const d = new Date(c.fim + 'T00:00:00');
        const diff = Math.ceil((d - today)/(1000*60*60*24));
        if(diff >= 0 && diff <= 60){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${c.numero}</td><td>${c.fornecedor}</td><td>${formatDateISOtoBR(c.fim)}</td><td>${diff} dias</td>
            <td>
              <button class="action-small" onclick="startEdit(${c.id})">‚úèÔ∏è Editar</button>
              <button class="action-small" onclick="deleteContract(${c.id})">üóëÔ∏è Excluir</button>
            </td>`;
          tbRenew.appendChild(tr);
        }
      });
    }

    // --- Attachments (simulated)
    function fillContractSelect(){
      const sel = document.getElementById('fileContratoSelect');
      sel.innerHTML = '<option value="">Selecionar contrato (opcional)</option>';
      contracts.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.numero} ‚Äî ${c.fornecedor}`;
        sel.appendChild(opt);
      });
    }

    document.getElementById('uploadBtn').addEventListener('click', ()=>{
      const input = document.getElementById('fileInput');
      const file = input.files[0];
      if(!file) return alert('Selecione um arquivo primeiro.');
      const contratoId = document.getElementById('fileContratoSelect').value || null;
      const reader = new FileReader();
      reader.onload = function(e){
        const base64 = e.target.result;
        const item = {
          id: Date.now()+Math.floor(Math.random()*999),
          name: file.name,
          size: file.size,
          type: file.type,
          contratoId: contratoId ? Number(contratoId) : null,
          uploadedAt: (new Date()).toISOString(),
          data: base64
        };
        attachments.push(item);
        saveAttachments(attachments);
        renderAttachments();
        input.value = '';
        alert('Arquivo salvo (simulado) no prot√≥tipo.');
      };
      reader.readAsDataURL(file);
    });

    function renderAttachments(){
      const list = document.getElementById('attachmentsList');
      list.innerHTML = '';
      if(attachments.length === 0){
        list.innerHTML = '<li class="muted">Nenhum anexo</li>';
        fillContractSelect();
        return;
      }
      attachments.forEach(a=>{
        const li = document.createElement('li');
        li.className = 'attach-item';
        const contractLabel = a.contratoId ? (contracts.find(c=>c.id===a.contratoId)?.numero || '‚Äî') : '‚Äî';
        li.innerHTML = `<div><strong>${a.name}</strong> <span class="muted">(${Math.round(a.size/1024)} KB) ‚Äî Contrato: ${contractLabel}</span></div>
          <div style="display:flex;gap:8px">
            <button class="action-small" onclick='viewAttachment("${a.id}")'>üîé Ver</button>
            <button class="action-small" onclick='deleteAttachment("${a.id}")'>üóëÔ∏è Excluir</button>
          </div>`;
        list.appendChild(li);
      });
      fillContractSelect();
    }

    function viewAttachment(id){
      const a = attachments.find(x => x.id == id);
      if(!a) return alert('Arquivo n√£o encontrado');
      // open in new tab if image/pdf else show name
      if(a.data && (a.type.startsWith('image/') || a.type === 'application/pdf')){
        const w = window.open();
        w.document.write(`<title>${a.name}</title>`);
        if(a.type.startsWith('image/')) w.document.write(`<img src="${a.data}" style="max-width:100%;height:auto"/>`);
        else w.document.write(`<iframe src="${a.data}" style="width:100%;height:100vh;border:0"></iframe>`);
      } else {
        alert(`Arquivo: ${a.name}\nTipo: ${a.type}\nTamanho: ${Math.round(a.size/1024)} KB`);
      }
    }
    function deleteAttachment(id){
      if(!confirm('Excluir anexo?')) return;
      attachments = attachments.filter(a=>a.id != id);
      saveAttachments(attachments);
      renderAttachments();
    }

    // --- Config form
    document.getElementById('configForm').addEventListener('submit', function(e){
      e.preventDefault();
      const fd = new FormData(this);
      settings.companyName = fd.get('companyName');
      settings.notificationEmail = fd.get('notificationEmail');
      settings.theme = fd.get('theme');
      saveSettings(settings);
      applySettings();
      alert('Configura√ß√µes salvas.');
    });

    // --- My contracts (where responsavel == current user name)
    function renderMyContracts(){
      const tbMeus = document.getElementById('tbMeus');
      tbMeus.innerHTML = '';
      if(!currentUser){
        tbMeus.innerHTML = '<tr><td colspan="6" class="muted">Fa√ßa login para ver seus contratos.</td></tr>';
        return;
      }
      const mine = contracts.filter(c => (c.responsavel || '').toLowerCase() === (currentUser.name || '').toLowerCase());
      if(mine.length === 0){
        tbMeus.innerHTML = '<tr><td colspan="6" class="muted">Nenhum contrato atribu√≠do a voc√™.</td></tr>';
        return;
      }
      mine.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.numero}</td><td>${c.fornecedor}</td><td>${formatDateISOtoBR(c.inicio)}</td><td>${formatDateISOtoBR(c.fim)}</td><td>${c.status}</td>
          <td><button class="action-small" onclick="viewContract(${c.id})">üîç</button> <button class="action-small" onclick="startEdit(${c.id})">‚úèÔ∏è</button></td>`;
        tbMeus.appendChild(tr);
      });
    }

    // --- Login simulated
    document.getElementById('btnLogin').addEventListener('click', ()=>{
      const name = document.getElementById('loginUser').value.trim();
      const email = document.getElementById('loginEmail').value.trim();
      if(!name || !email) return alert('Preencha nome e e-mail para logar (simulado).');
      currentUser = { name, email };
      saveUser(currentUser);
      ensureUser();
      alert('Logado como ' + name);
      show('dashboard');
    });

    // logout helper (not in UI) - for dev
    window._logout = function(){ localStorage.removeItem(STORAGE_KEYS.user); currentUser = null; ensureUser(); show('dashboard'); alert('Logout (simulado)'); }

    // expose some functions for buttons inside generated HTML
    window.startEdit = startEdit;
    window.deleteContract = deleteContract;
    window.viewContract = viewContract;
    window.viewAttachment = viewAttachment;
    window.deleteAttachment = deleteAttachment;

    // fill contract select & initial render
    function init(){
      applySettings();
      ensureUser();
      renderTable(contracts);
      fillContractSelect();
      renderAttachments();
      document.getElementById('totalCount').textContent = contracts.length;
    }

    // load attachments and settings from storage
    attachments = loadAttachments();
    settings = loadSettings();
    contracts = loadContracts();
    init();

    // show dashboard by default
    show('dashboard');

    // expose renderTable for debugging
    window.renderTable = renderTable;

  </script>
</body>
</html>

